<?xml version='1.0' encoding='UTF-8'?>
<document>
  <properties>
    <title>In Fess make Apache Solr based search server-part role-based search</title>
    <author>Shinsuke Sugaya</author>
  </properties>
  <body>

    <section name='Introduction'>
    <p>
      The last time<a href='http://codezine.jp/article/detail/4527'>Mobile Edition</a>Or how to build mobile device-friendly search system using Fess was introduced.
    Introduces role-based search feature is also distinctive features of Fess one thing in this article.</p>
    <p>
      In this article, explains Fess 8.2.0. About how to build a Fess<a href='http://codezine.jp/article/detail/4526'>Introduction chapter</a>Please see the.
    </p>
    </section>
    <section name='Intended audience'>
    <ul>
      <li>More authentication such as portal sites like seen in search system building</li>
      <li>Want to build an environment to search for viewing permissions each</li>
    </ul>
    </section>

    <section name='Required environment'>
    <p>
      Regarding the content of this article in the following environment and behavior verification.
    </p>
    <ul>
      <li>
        CentOS 5.5
      </li>
      <li>
        JDK 1.6.0_22
      </li>
    </ul>
    </section>

    <section name='Role-based search'>
    <p>
      Is divided out search results user and role-based search of the Fess, authenticated in any authentication system authentication information to the original function.
      For example, search for technical personnel b sales reps A sales division role shows a sales division role information in search results, sales of rolls does not appear it.
    By using this feature, user login in the portal and single sign-on environment belongs to you can enable search, sector or job title.</p>
    <p>
      In Fess role-based search to retrieve role information from the following places can be.
    </p>
    <ol>
      <li>Request parameter</li>
      <li>Request header</li>
      <li>Cookies</li>
      <li>J2EE authentication information</li>
    </ol>
    <p>
      Role information to pass to the Fess, usages, in the Portal Server and agent-based single sign-on system authentication when running Fess&apos;s domain and path to save authentication information in cookies.
      By reverse proxy type single sign-on system access to Fess to add authentication information request headers and request parameters can retrieve role information in Fess.
    You can thus various authentication systems and working with the search results to put out separate.</p>
    <p>
      To cope with that to provide a class to implement the jp.sf.fess.helper.RoleQueryHelper interface if you are running your own authentication system. The class &apos;<code>webapps/fess/WEB-INF/classes</code>&apos; As in, have put in place through the classpath &quot;<code>webapps/fess/WEB-INF/classes/fess.dicon</code>&quot;In the given on behalf of the jp.sf.fess.helper.impl.RoleQueryHelperImpl.
    </p>
    </section>

    <section name='To use role-based search settings'>
    <p>
      By installing a Fess 8.2.0. If you have not installed yet,<a href='http://codezine.jp/article/detail/4526'>Introduction chapter</a>Please install, refer to.
    </p>
    <p>
      Describes the role-based search using the credentials of the J2EE (Tomcat authentication) provides the Fess existing login screen using various authentication systems but without building a separate authentication systems in Fess Tomcat authentication environment, so use this in this article.
    </p>

    <subsection name='Add a user to the Tomcat'>
    <p>
      First of all, search results separate out, to show to Tomcat users.
      This time, create sales （ sales ） and engineering (eng) two rolls.
      And the user adds taro and hanako users belong to the eng role belongs to the sales role. User information below to see<code>conf/Tomcat-users.XML</code>&quot;To write.
    </p>
    <div class='src_frame'>
      <div class='caption'>contents of Tomcat-users.XML</div>
<pre class='prettyprint'>
&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;
&lt;tomcat-users&gt;
  &lt;role rolename=&quot;fess&quot;&gt;&lt;/role&gt;
  &lt;role rolename=&quot;solr&quot;&gt;&lt;/role&gt;
  &lt;role rolename=&quot;manager&quot;&gt;&lt;/role&gt;
  &lt;role rolename=&quot;sales&quot;&gt;&lt;/role&gt;&lt;!-- 追加 --&gt;
  &lt;role rolename=&quot;eng&quot;&gt;&lt;/role&gt;&lt;!-- 追加 --&gt;
  &lt;user username=&quot;admin&quot; password=&quot;admin&quot; roles=&quot;fess&quot;&gt;&lt;/user&gt;
  &lt;user username=&quot;solradmin&quot; password=&quot;solradmin&quot; roles=&quot;solr&quot;&gt;&lt;/user&gt;
  &lt;user username=&quot;manager&quot; password=&quot;manager&quot; roles=&quot;manager&quot;&gt;&lt;/user&gt;
  &lt;user username=&quot;taro&quot; password=&quot;taropass&quot; roles=&quot;sales&quot;&gt;&lt;/user&gt;&lt;!-- 追加 --&gt;
  &lt;user username=&quot;hanako&quot; password=&quot;hanakopass&quot; roles=&quot;eng&quot;&gt;&lt;/user&gt;&lt;!-- 追加 --&gt;
&lt;/tomcat-users&gt;
</pre>
    </div>
    <p>
      This setting is not required if the use of an existing authentication system.
    </p>
    </subsection>

    <subsection name='Fess.dicon settings'>
    <p>
      Here&apos;s the settings for the Fess. First of all, &apos;<code>webapps/fess/WEB-INF/classes/fess.dicon</code>&quot;The roleQueryHelper sets how to retrieve the default roles and authentication information. By using the J2EE authentication information, so see<code>Fess.dicon</code>&quot;The roleQueryHelper will set like the following.
    </p>
    <div class='src_frame'>
      <div class='caption'>contents of Fess.dicon</div>
<pre class='prettyprint'>:
&lt;component name=&quot;roleQueryHelper&quot; class=&quot;jp.sf.fess.helper.impl.RoleQueryHelperImpl&quot;&gt;
    &lt;property name=&quot;defaultRoleList&quot;&gt;
        {&quot;guest&quot;}
    &lt;/property&gt;
&lt;/component&gt;
:</pre>
    </div>
    <p>
      Set the default role as above.
      Treated as the role search to locate the default roles are not logged in.
    All search results are displayed on the status not logged in and you do not specify a default search.</p>
    <p>
      About the J2EE authentication information not available if worth mentioning here.
    If the authentication information from the request parameter set follows.</p>
    <div class='src_frame'>
      <div class='caption'>contents of Fess.dicon</div>
<pre class='prettyprint'>: &lt;component name=&quot;roleQueryHelper&quot; class=&quot;jp.sf.fess.helper.impl.RoleQueryHelperImpl&quot;&gt; &lt;property name=&quot;parameterKey&quot;&gt;&quot;fessRoles&quot;&lt;/property&gt;,&lt;property name=&quot;encryptedParameterValue&quot;&gt;false&lt;/property&gt; &lt;property name=&quot;defaultRoleList&quot;&gt; {guest}&lt;/property&gt; 
    
    
    
&lt;/component&gt; :</pre>
    </div>
    <p>
      Key request parameter specifying where fessRoles can pass the role information in the comma-separated values. For example, the URL to locate the user with the sales and admin roles &apos;<code>http: //hostname/fess/search?</code>&apos; The so will be added fessRoles.
      You can pass here encryptedParameterValue is set to false, this value to true and encrypt, Blowfish or AES in the value part of the fessRoles.
    You need to set if you encrypt the value to be FessCipher components, so that you can decrypt.</p>
    <p>
      If the authentication information from the request header set shown below.
    </p>
    <div class='src_frame'>
      <div class='caption'>contents of Fess.dicon</div>
<pre class='prettyprint'>: &lt;component name=&quot;roleQueryHelper&quot; class=&quot;jp.sf.fess.helper.impl.RoleQueryHelperImpl&quot;&gt; &lt;property name=&quot;headerKey&quot;&gt;&quot;fessRoles&quot;&lt;/property&gt;,&lt;property name=&quot;encryptedParameterValue&quot;&gt;false&lt;/property&gt; &lt;property name=&quot;defaultRoleList&quot;&gt; {guest}&lt;/property&gt; 
    
    
    
&lt;/component&gt; :</pre>
    </div>
    <p>
      You can specify fessRoles in the request header key, role information to pass in comma-separated values.
    </p>
    <p>
      If the authentication information from the cookie set shown below.
    </p>
    <div class='src_frame'>
      <div class='caption'>contents of Fess.dicon</div>
<pre class='prettyprint'>: &lt;component name=&quot;roleQueryHelper&quot; class=&quot;jp.sf.fess.helper.impl.RoleQueryHelperImpl&quot;&gt; &lt;property name=&quot;cookieKey&quot;&gt;&quot;fessRoles&quot;&lt;/property&gt;,&lt;property name=&quot;encryptedParameterValue&quot;&gt;false&lt;/property&gt; &lt;property name=&quot;defaultRoleList&quot;&gt; {guest}&lt;/property&gt; 
    
    
    
&lt;/component&gt; :</pre>
    </div>
    <p>
      You can specify fessRoles to the name of the cookie, as well as the request parameter, pass the role information in the comma-separated values.
    </p>
    </subsection>

    <subsection name='Web.xml settings'>
    <p>
      「<code>Fess.dicon</code>&quot;And to ensure you can log in as&quot;<code>webapps/fess/WEB-INF/web.xml</code>&quot;The change security-related settings.
    The following settings.</p>
    <div class='src_frame'>
      <div class='caption'>the content of</div>
<pre class='prettyprint'>: &lt;security-constraint&gt; &lt;web-resource-collection&gt; &lt;web-resource-name&gt;Fess Authentication&lt;/web-resource-name&gt;&lt;url-pattern&gt;/login/login&lt;/url-pattern&gt;
    
    
  &lt;/web-resource-collection&gt;&lt;auth-constraint&gt;&lt;role-name&gt;fess&lt;/role-name&gt;&lt;role-name&gt;sales&lt;/role-name&gt;&lt;role-name&gt;eng&lt;/role-name&gt; 
    
    
    
  &lt;/auth-constraint&gt; 
  
  
&lt;/security-constraint&gt; : &lt;security-role&gt;&lt;role-name&gt;fess&lt;/role-name&gt;
  
&lt;/security-role&gt;&lt;security-role&gt;&lt;role-name&gt;sales&lt;/role-name&gt;
  
&lt;/security-role&gt;&lt;security-role&gt;&lt;role-name&gt;eng&lt;/role-name&gt;
  
&lt;/security-role&gt;

</pre>
    </div>
    <p>
      This setting is required if you are using authentication, such as a request parameter.
    </p>
    </subsection>

    </section>

    <section name='Perform role-based search'>
    <p>
      Complete Setup so please start Fess.
    </p>

    <subsection name='Confirmation of registered users'>
    <p>
      Has been turned by this admin, taro, and hanako 3 user Fess to log.
      Verify that you can log in to.<a href='http://localhost:8080/fess/admin/' target='_blank'>/ http://localhost:8080/Fess/Admin</a>To access the login in the admin user and as usual management screen appears. Then logged out admin user, again<a href='http://localhost:8080/fess/admin/' target='_blank'>/ http://localhost:8080/Fess/Admin</a>To access, please login with taro and hanako users. After a successful login, and<a href='http://localhost:8080/fess/' target='_blank'>/ http://localhost:8080/Fess</a>The search screen is displayed. When you log out<a href='http://localhost:8080/fess/admin/' target='_blank'>/ http://localhost:8080/Fess/Admin</a>To access, click the logout button.
    </p>
    <div class='centerimg'>
      <div class='caption'>Logout screen</div>
      <div class='img'>
        <a href='/images/ja/article/3/logout.png' rel='lightbox'><img alt='Logout screen' src='/images/ja/article/3/logout.png'/></a>
      </div>
    </div>
    </subsection>

    <subsection name='Create a role'>
    <p>
      logged in as admin user and lists the role role in the left menu to click.
    We create three roles.</p>
    <div class='tbl_frame'>
      <div class='cap'>Role list</div>
      <table class='tbl' width='200'>
        <tbody>
          <tr>
            <td class='th'>Role name</td>
            <td class='th'>Value</td>
          </tr>
          <tr>
            <td>By default</td>
            <td>default</td>
          </tr>
          <tr>
            <td>Sales Department</td>
            <td>sales</td>
          </tr>
          <tr>
            <td>Technology Department</td>
            <td>Eng</td>
          </tr>
        </tbody>
      </table>
    </div>
    </subsection>

    <subsection name='Add a crawl settings'>
    <p>
      Create a crawl. This time the users in the sales department role<a href='http://www.n2sm.net/' target='_blank'>http://www.n9sm.NET/</a>Only, you can search for users of the technology of roll<a href='http://fess.codelibs.org/' target='_blank'>http://Fess.codelibs.org/</a>Just so that you can find.
      In order to crawl settings, click on the left menu [Web], lists the Web crawl settings.
      Click the [create new], please create a Web crawl settings. First of all, sales for the<a href='http://www.n2sm.net/' target='_blank'>http://www.n2sm.NET/</a>To the Sales Department, select [role] item as the crawl settings, create. In the following<a href='http://fess.codelibs.org/' target='_blank'>http://Fess.codelibs.org/</a>The create a role Select technology, in the crawl settings.
    </p>
    <div class='centerimg'>
      <div class='caption'>Web crawl settings roll items</div>
      <div class='img'>
        <a href='/images/ja/article/3/crawl-conf-role.png' rel='lightbox'><img alt='Web crawl settings roll items' src='/images/ja/article/3/crawl-conf-role.png'/></a>
      </div>
    </div>
    </subsection>

    <subsection name='Crawl started'>
    <p>
      Registration after the crawl settings, click System settings on the left menu, click the Start button in the system settings screen, starts to crawl.
    While wait for crawl to complete.</p>
    </subsection>

    <subsection name='Search'>
    <p>
      After crawling,<a href='http://localhost:8080/fess/' target='_blank'>/ http://localhost:8080/Fess</a>To make sure that search word, such as &quot;fess&quot; access, not logged in, search results are displayed.
      Then logged in taro, as well as search. for taro user has a sales role<a href='http://www.n2sm.net/' target='_blank'>http://www.n9sm.NET/</a>The only search results are displayed.
    </p>
    <div class='centerimg'>
      <div class='caption'>Search screen in the sales role</div>
      <div class='img'>
        <a href='/images/ja/article/3/search-by-sales.png' rel='lightbox'><img alt='Search screen in the sales role' src='/images/ja/article/3/search-by-sales.png'/></a>
      </div>
    </div>
    <p>
      Taro user logout, please login with hanako users. Destination and so have eng role hanako users as well as search and<a href='http://fess.codelibs.org/' target='_blank'>http://Fess.codelibs.org/</a>The only search results are displayed.
    </p>
    <div class='centerimg'>
      <div class='caption'>in the Eng role search screen</div>
      <div class='img'>
        <a href='/images/ja/article/3/search-by-eng.png' rel='lightbox'><img alt='in the Eng role search screen' src='/images/ja/article/3/search-by-eng.png'/></a>
      </div>
    </div>
    </subsection>

    </section>

    <section name='Summary'>
    <p>
      I introduced about the security features of the Fess in role-based search.
      I think various authentication systems to accommodate because mainly covers the J2EE authentication information by using role-based search, but the passing of authentication information to the Fess general implementation.
    It is possible to realize systems so each attribute in the user search results out into the corporate portal site or shared folder browsing permissions per search is required.</p>
    <p>
      Next offers Fess of Ajax functions are introduced here.
    </p>
    </section>

    <section name='Reference material'>
    <ul>
      <li>
        <a href='http://fess.codelibs.org/ja/'>Fess</a>
      </li>
    </ul>
    </section>
  </body>
</document>
